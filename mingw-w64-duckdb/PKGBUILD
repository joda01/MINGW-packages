# Maintainer: Alexey Pavlov <alexpux@gmail.com>

_realname=duckdb
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=0.10.2
_tag=v0.10.2
pkgrel=1
pkgdesc="A fast in-process analytical database"
arch=(any)
mingw_arch=('mingw32' 'mingw64' 'ucrt64' 'clang64' 'clang32' 'clangarm64')
url="https://duckdb.org/"
license=('MIT')
depends=()
makedepends=(
             "${MINGW_PACKAGE_PREFIX}-binutils"
             "${MINGW_PACKAGE_PREFIX}-crt-git"
             "${MINGW_PACKAGE_PREFIX}-gcc"
             "${MINGW_PACKAGE_PREFIX}-gdb"
             "${MINGW_PACKAGE_PREFIX}-gdb-multiarch"
             "${MINGW_PACKAGE_PREFIX}-headers-git"
             "${MINGW_PACKAGE_PREFIX}-libmangle-git"
             "${MINGW_PACKAGE_PREFIX}-libwinpthread-git"
             "${MINGW_PACKAGE_PREFIX}-winpthreads-git"
             "${MINGW_PACKAGE_PREFIX}-make"
             "${MINGW_PACKAGE_PREFIX}-pkgconf"
             "${MINGW_PACKAGE_PREFIX}-tools-git"
             "${MINGW_PACKAGE_PREFIX}-winstorecompat-git"
             "${MINGW_PACKAGE_PREFIX}-cmake"
             "${MINGW_PACKAGE_PREFIX}-ninja")
source=("${_realname}-${pkgver}.tar.gz::https://github.com/duckdb/duckdb/archive/${_tag}.tar.gz")
noextract=("${_realname}-${pkgver}.tar.gz")
sha256sums=('662a0ba5c35d678ab6870db8f65ffa1c72e6096ad525a35b41b275139684cea6')


prepare() {
  tar -xf "${_realname}-${pkgver}.tar.gz" || true
  python -m pip install pytest
  cd "${srcdir}/${_realname}-${pkgver}"
  python scripts/windows_ci.py
}

build() {
  cd "${srcdir}/${_realname}-${pkgver}"
  

  cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_GENERATOR_PLATFORM=x64 -DENABLE_EXTENSION_AUTOLOADING=1 -DENABLE_EXTENSION_AUTOINSTALL=1 -DDUCKDB_EXTENSION_CONFIGS="${srcdir}/${_realname}-${pkgver}/.github/config/bundled_extensions.cmake" -DBUILD_ODBC_DRIVER=1 -DDISABLE_UNITY=1 -DOVERRIDE_GIT_DESCRIBE="${_tag}"
  cmake --build . --config Release
}

package() {
  cp "${srcdir}/${_realname}-${pkgver}/src/libduckdb.dll" "${pkgdir}${MINGW_PREFIX}/bin"
}


#
#package() {
#  cd "${srcdir}/build-${MSYSTEM}"
#
#  DESTDIR="${pkgdir}" "${MINGW_PREFIX}"/bin/cmake.exe --install .
#
#  install -Dm644 "${srcdir}/${_realname}-${_tag}/LICENSE" "${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}/LICENSE"
#}

#
#